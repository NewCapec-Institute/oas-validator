<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" >
<head>
  <meta content="text/html;charset=UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>The OpenAPI Specification Tools - Compliance Validator</title>

  <link href="asserts/css/bootstrap.min.css" th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.css}" rel="stylesheet">
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <!-- Navbar content -->
    <a class="navbar-brand" href="#">树维 Supwisdom</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="#" th:href="@{/}">首页</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" th:href="@{/viewer}">查看器</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" th:href="@{/editor}">编辑器</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#" th:href="@{/validator}">验证器 <span class="sr-only">(current)</span></a>
        </li>
      </ul>
    </div>
  </nav>
  
  <div style="height: 50px;"></div>

  <div class="container">
    
    <h2>合规性校验 &nbsp;&nbsp;&nbsp;&nbsp;<span style="font-size: 1rem;">[<a href="#" th:href="@{/doc/validator.html#header-n20}" target="_blank">文档</a>]</span> </h2>
    <span>OAS必须符合[<a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md" target="_blank">OAS 3.0.2规范</a>]（比如属性的名称、REQUIED要求）。除此之外则是我们自己的定义的合规性检查。</span>
    <div class="" style="height: 20px;"></div>
  
    <div>
      <textarea name="yaml" placeholder="OpenAPI Document（yaml）" style="width: 40%; height: 480px;"></textarea>
      <div>
      <button id="complianceValidate" class="btn btn-info">合规性校验</button>
      </div>
    </div>
    
    <div class="" style="height: 20px;"></div>
    
    <div>
      <code id="complianceViolations"></code>
    </div>

    <div class="" style="height: 20px;"></div>
  
  </div>
  
    
  <script type="text/javascript" src="" th:src="@{/webjars/jquery/3.0.0/jquery.js}"></script>
  <script type="text/javascript" src="" th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.js}"></script>
  
  <script type="text/javascript">
  $(function(){
    
    $('#complianceValidate').on('click', function(e) {
      var url = "/api/compliance";
      
      var yaml = $('textarea[name="yaml"]').val(); if (yaml=="") {return;}
      
      var data = yaml
      
      post(url, data, function(json) {
        console.log(json);
        
        if (!json.acknowleged) {
          alert('出错了');
        }
        
        var data = json.data;
        
        var violations = data.violations;
        
        if (violations && violations.length == 0) {
          alert('文档合规');
        }
        
        var complianceViolations = $("#complianceViolations");
        
        complianceViolations.empty();
        
        $.each(violations, function(i) {
          var violation = violations[i];
          
          var locationPath = "";
          $.each(violation.location.path, function(j) {
            var p = violation.location.path[j];
            locationPath += p.name+'.';
          });
          if (locationPath.length > 0) {
          	locationPath = locationPath.substring(0, locationPath.length-1);
          }
          
          var errorInfo = ""+ locationPath + " : "+"< " + violation.error + " >";
          
          complianceViolations.append(errorInfo);
          complianceViolations.append("<br/>");
        });
        
      });
    });

  });
  
  function post(url, data, cb) {// application/json // text/plain
    
    $.ajax({
      url: url, 
      data: data,
      type: 'post',
      headers: {
        "Accept": "application/json; charset=utf-8", 
        "Content-Type": "text/plain; charset=utf-8"
      },
      success: function(json) {
        cb(json);
      }
    });
    
  }
  
  </script>
  
</body>

</html>